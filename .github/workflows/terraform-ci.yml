name: Validación CI de Módulos Terraform

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      - name: Instalar Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Instalar TFLint
        run: |
          curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash

      - name: Detectar módulos modificados
        id: modulos
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
              BASE_SHA="${{ github.event.pull_request.base.sha }}"
              HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
              BASE_SHA=$(git rev-parse HEAD^)
              HEAD_SHA=$(git rev-parse HEAD)
          fi
        
          echo "BASE_SHA=$BASE_SHA"
          echo "HEAD_SHA=$HEAD_SHA"
        
          MODULOS=$(git diff --name-only $BASE_SHA $HEAD_SHA | cut -d/ -f1 | sort -u | grep -v '^\\.github$')
        
          echo "Módulos detectados: $MODULOS"
          echo \"modulos=$MODULOS\" >> $GITHUB_OUTPUT
        

      - name: Validar cada módulo cambiado
        if: steps.modulos.outputs.modulos != ''
        run: |
          for dir in ${{ steps.modulos.outputs.modulos }}; do
            echo "\n🔍 Validando módulo: $dir"
            cd $dir
            terraform init -backend=false
            terraform validate
            terraform fmt -check -recursive
            tflint --init
            tflint
            cd -
          done
