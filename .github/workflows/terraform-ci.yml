name: Validación CI de Módulos Terraform

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      - name: Instalar Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Instalar TFLint
        run: |
          curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash

      - name: Detectar módulos modificados
        id: modulos
        run: |
          BASE_REF=$(git merge-base HEAD HEAD^)
          MODULOS=$(git diff --name-only $BASE_REF HEAD | cut -d/ -f1 | sort -u | grep -v '^\\.github$')
          echo "Módulos detectados: $MODULOS"
          echo "modulos=$MODULOS" >> $GITHUB_OUTPUT

      - name: Validar cada módulo cambiado
        if: steps.modulos.outputs.modulos != ''
        run: |
          for dir in ${{ steps.modulos.outputs.modulos }}; do
            echo "\n🔍 Validando módulo: $dir"
            cd $dir
            terraform init -backend=false
            terraform validate
            terraform fmt -check -recursive
            tflint --init
            tflint
            cd -
          done
